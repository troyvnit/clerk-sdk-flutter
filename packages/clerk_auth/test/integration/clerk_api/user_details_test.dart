import 'package:clerk_auth/src/clerk_api/api.dart';
import 'package:clerk_auth/src/clerk_auth/auth_config.dart';
import 'package:clerk_auth/src/clerk_auth/persistor.dart';
import 'package:clerk_auth/src/models/api/api_response.dart';
import 'package:clerk_auth/src/models/client/email.dart';
import 'package:clerk_auth/src/models/client/phone_number.dart';
import 'package:clerk_auth/src/models/client/strategy.dart';
import 'package:clerk_auth/src/models/client/user.dart';
import 'package:clerk_auth/src/models/enums.dart';
import 'package:clerk_auth/src/models/environment/config.dart';
import 'package:clerk_auth/src/utils/logging.dart';
import 'package:test/test.dart';
import 'package:uuid/uuid.dart';

import '../../test_helpers.dart';

// Note that these are integration tests with a live backend. The configuration of the backend
// will affect the outcome of the tests. It is assumed that the account has been configured to
// allow users to change their first and last names

void main() {
  late final Api api;
  late final TestEnv env;
  final httpService = TestHttpService();
  final expireAt = DateTime.timestamp() //
      .add(const Duration(minutes: 5))
      .millisecondsSinceEpoch;

  setUpAll(() async {
    env = TestEnv('.env.test');
    api = Api(
      config: AuthConfig(
        publishableKey: env.publishableKey,
        localesLookup: testLocalesLookup,
        persistor: Persistor.none,
        httpService: httpService,
      ),
    );
    await api.initialize();
    await setUpLogging(printer: TestLogPrinter(), level: Level.SEVERE);
  });

  Future<void> signIn(int id) async {
    httpService.expect('DELETE /v1/client', 200, '');
    await api.signOut();

    httpService.expect(
      'POST /v1/client/sign_ins identifier=test$id+clerk_test@some.domain',
      200,
      '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test$id+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732103021570},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test$id+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test$id+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732103021570},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016621596}}',
    );
    final response =
        await api.createSignIn(identifier: 'test$id+clerk_test@some.domain');

    httpService.expect(
      'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/attempt_first_factor strategy=password&password=password',
      200,
      '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"complete","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":null,"supported_second_factors":null,"first_factor_verification":{"status":"verified","strategy":"password","attempts":1,"expire_at":null},"second_factor_verification":null,"identifier":"test$id+clerk_test@some.domain","USER_ID":null,"created_session_id":"SESSION_ID","abandon_at":1732103021570},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test$id+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622171,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test$id+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODIsImlhdCI6MTczMjAxNjYyMiwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEyLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.MvVkZX6QALcyOfK4cIhAoqrVVqlFkiKPSpYSgqdejTOLP_wG-vPahiPRGJMJgYjIQIZiDwU--p-rECXyONN_C1D4aXS6VlQJjw92wfrOavH53Dp3y3XZdOcXFW-6ajDGv6vvZ9CVJUi5kWw4qT3XCqM7UPSnj9ih-fbMOIXRxPUTILVPTqNeJ0tk0hLx1s0rZ0AYBWP-DOmPY5idQV96J7WKGLgjiR-yckNK9_sxg8VFnQyVxGb4YVLrNuU6ZYG6EwGkxXAjGY1xfbPizWyVKSP76XncRtnlFnJVAUTnG7zFUyqP6AH-aZdOZGEMwdF2oAgK3STA7oPO9Y1X5W73CA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
    );
    await api.attemptSignIn(
      response.client!.signIn!,
      stage: Stage.first,
      strategy: Strategy.password,
      password: 'password',
    );
  }

  tearDown(() async {
    httpService.expect('DELETE /v1/client', 200, '');
    await api.signOut();
  });

  group('Can update user:', () {
    test('with new name', () async {
      await runWithLogging(() async {
        await signIn(1);

        late ApiResponse response;
        late User? user;

        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622171,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622171,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODIsImlhdCI6MTczMjAxNjYyMiwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEyLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.MvVkZX6QALcyOfK4cIhAoqrVVqlFkiKPSpYSgqdejTOLP_wG-vPahiPRGJMJgYjIQIZiDwU--p-rECXyONN_C1D4aXS6VlQJjw92wfrOavH53Dp3y3XZdOcXFW-6ajDGv6vvZ9CVJUi5kWw4qT3XCqM7UPSnj9ih-fbMOIXRxPUTILVPTqNeJ0tk0hLx1s0rZ0AYBWP-DOmPY5idQV96J7WKGLgjiR-yckNK9_sxg8VFnQyVxGb4YVLrNuU6ZYG6EwGkxXAjGY1xfbPizWyVKSP76XncRtnlFnJVAUTnG7zFUyqP6AH-aZdOZGEMwdF2oAgK3STA7oPO9Y1X5W73CA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
        );
        httpService.expect(
          'PATCH /v1/me?_clerk_session_id=SESSION_ID first_name=New&last_name=Cognomen&primary_email_address_id=IDENTIFIER_ID&primary_phone_number_id=IDENTIFIER_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test1","first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622763,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622763,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODIsImlhdCI6MTczMjAxNjYyMiwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEyLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.MvVkZX6QALcyOfK4cIhAoqrVVqlFkiKPSpYSgqdejTOLP_wG-vPahiPRGJMJgYjIQIZiDwU--p-rECXyONN_C1D4aXS6VlQJjw92wfrOavH53Dp3y3XZdOcXFW-6ajDGv6vvZ9CVJUi5kWw4qT3XCqM7UPSnj9ih-fbMOIXRxPUTILVPTqNeJ0tk0hLx1s0rZ0AYBWP-DOmPY5idQV96J7WKGLgjiR-yckNK9_sxg8VFnQyVxGb4YVLrNuU6ZYG6EwGkxXAjGY1xfbPizWyVKSP76XncRtnlFnJVAUTnG7zFUyqP6AH-aZdOZGEMwdF2oAgK3STA7oPO9Y1X5W73CA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
        );
        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test1","first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622763,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016622763,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"New","last_name":"Cognomen","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiTkMifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODMsImlhdCI6MTczMjAxNjYyMywiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEzLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.nwfUsotPCwP0mzpu3a-HR-0d0h5uELQcUc87t2a72pQ17-Vxyg70LH7U0kpLmqpmiPDGEHj2yvXMRllTc_idZsHhPc3P4SXRCKijatap6zKPn8rg6GyTHA2Khpouek2ccR325fot3NxbU-3ApWSWLyq10mx_fV6vs9DKKVBE6U8luaQxqJbfBt-NoU37GSEMm6i5DOmaHwvULFETodd9nclD4WbrGPtxbrzp5nkNWu3YrFM026jwaEBYVY4ULkJyw2vPy8kfvpLSC6InilbooEvVyDxGX4Q8mT-Ew2K5B1zEZDHRawqzalDSFF-QGTfLfp8kM7wR80sVrB-LxglFAQ"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
        );
        httpService.expect(
          'PATCH /v1/me?_clerk_session_id=SESSION_ID first_name=Test&last_name=User&primary_email_address_id=IDENTIFIER_ID&primary_phone_number_id=IDENTIFIER_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016623480,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016623480,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODMsImlhdCI6MTczMjAxNjYyMywiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEzLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.nwfUsotPCwP0mzpu3a-HR-0d0h5uELQcUc87t2a72pQ17-Vxyg70LH7U0kpLmqpmiPDGEHj2yvXMRllTc_idZsHhPc3P4SXRCKijatap6zKPn8rg6GyTHA2Khpouek2ccR325fot3NxbU-3ApWSWLyq10mx_fV6vs9DKKVBE6U8luaQxqJbfBt-NoU37GSEMm6i5DOmaHwvULFETodd9nclD4WbrGPtxbrzp5nkNWu3YrFM026jwaEBYVY4ULkJyw2vPy8kfvpLSC6InilbooEvVyDxGX4Q8mT-Ew2K5B1zEZDHRawqzalDSFF-QGTfLfp8kM7wR80sVrB-LxglFAQ"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
        );
        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016623480,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734608622117,"last_active_at":1732016622117,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732016622125,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732016623480,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731928604966,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732016622125,"updated_at":1732016622187,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTY2ODMsImlhdCI6MTczMjAxNjYyMywiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE2NjEzLCJzaWQiOiJzZXNzXzJwNERuZjZDamVZMXN0RnB1Z1lQSU52YmJxdCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.nwfUsotPCwP0mzpu3a-HR-0d0h5uELQcUc87t2a72pQ17-Vxyg70LH7U0kpLmqpmiPDGEHj2yvXMRllTc_idZsHhPc3P4SXRCKijatap6zKPn8rg6GyTHA2Khpouek2ccR325fot3NxbU-3ApWSWLyq10mx_fV6vs9DKKVBE6U8luaQxqJbfBt-NoU37GSEMm6i5DOmaHwvULFETodd9nclD4WbrGPtxbrzp5nkNWu3YrFM026jwaEBYVY4ULkJyw2vPy8kfvpLSC6InilbooEvVyDxGX4Q8mT-Ew2K5B1zEZDHRawqzalDSFF-QGTfLfp8kM7wR80sVrB-LxglFAQ"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732016621555,"updated_at":1732016622183}}',
        );

        const config = Config(
          allowsFirstName: true,
          allowsLastName: true,
        );

        response = await api.getUser();
        expect(response.client?.activeSession?.user is User, true);

        user = response.client!.activeSession!.user;
        response = await api.updateUser(
          user.copyWith(firstName: 'New', lastName: 'Cognomen'),
          config,
        );
        expect(response.isOkay, true);

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        expect(user?.name, 'New Cognomen');

        user = response.client!.activeSession!.user;
        response = await api.updateUser(
          user.copyWith(firstName: 'Test', lastName: 'User'),
          config,
        );
        expect(response.isOkay, true);

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        expect(user?.name, 'Test User');
      });
    });

    test('with additional email', () async {
      await runWithLogging(() async {
        await signIn(2);

        late ApiResponse response;
        late User? user;

        final emailAddress = 'user-${const Uuid().v4()}+clerk_test@some.domain';

        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018817848,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731931563814,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734610817790,"last_active_at":1732018817790,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018817848,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731931563814,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test2+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732018817799,"updated_at":1732018817863,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTg4NzgsImlhdCI6MTczMjAxODgxOCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE4ODA4LCJzaWQiOiJzZXNzXzJwNElGWlg3Tk9Jd25aV0htZHZ5V0lsVUN1bCIsInN1YiI6InVzZXJfMm1uS1o0ZXhpUHBIWTczMDhYeno5bWdmSldOIn0.wx96DzzUaD-hwTv4TnJWX30f7ttRDzu9PdGkEz2sHNCC_jF8N7W-fQy6soa0We7aycz1tm3TGJBxdI4qWFfV3ADERRbF1dWBU_UvgV5HT9Jt8TGR1CW1k2a6vw9eX-4a_NbnWbm_ohQv0lY-cLQzTOFsTDoKD991HpJklHC1wVDeVMo_raMMJteNZkF7yoT9ap-_OMBeFi6ZhTTcZGZJ4l8e4g30WrkvLbunpB9h4NcgGXRbhOr3cfVZ7X8T3KfOOjpo7HqbPs24Gn37WyG-Obu4efzmTuzbUj571L52LkR8yVubAJ0F12J9aPjUUMklrSD-f-h5SQEz8PGIDcwgcA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732018817312,"updated_at":1732018817860}}',
        );
        httpService.expect(
          'POST /v1/me/email_addresses?_clerk_session_id=SESSION_ID email_address=$emailAddress',
          200,
          '{"response":{"id":"IDENTIFIER_ID","object":"email_address","email_address":"$emailAddress","reserved":false,"verification":null,"linked_to":[],"created_at":1732018818573,"updated_at":1732018818573},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734610817790,"last_active_at":1732018817790,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"$emailAddress","reserved":false,"verification":null,"linked_to":[],"created_at":1732018818573,"updated_at":1732018818573},{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018817848,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731931563814,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test2+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732018817799,"updated_at":1732018817863,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTg4NzgsImlhdCI6MTczMjAxODgxOCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE4ODA4LCJzaWQiOiJzZXNzXzJwNElGWlg3Tk9Jd25aV0htZHZ5V0lsVUN1bCIsInN1YiI6InVzZXJfMm1uS1o0ZXhpUHBIWTczMDhYeno5bWdmSldOIn0.wx96DzzUaD-hwTv4TnJWX30f7ttRDzu9PdGkEz2sHNCC_jF8N7W-fQy6soa0We7aycz1tm3TGJBxdI4qWFfV3ADERRbF1dWBU_UvgV5HT9Jt8TGR1CW1k2a6vw9eX-4a_NbnWbm_ohQv0lY-cLQzTOFsTDoKD991HpJklHC1wVDeVMo_raMMJteNZkF7yoT9ap-_OMBeFi6ZhTTcZGZJ4l8e4g30WrkvLbunpB9h4NcgGXRbhOr3cfVZ7X8T3KfOOjpo7HqbPs24Gn37WyG-Obu4efzmTuzbUj571L52LkR8yVubAJ0F12J9aPjUUMklrSD-f-h5SQEz8PGIDcwgcA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732018817312,"updated_at":1732018817860}}',
        );
        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"$emailAddress","reserved":false,"verification":null,"linked_to":[],"created_at":1732018818573,"updated_at":1732018818573},{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018817848,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731931563814,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734610817790,"last_active_at":1732018817790,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"$emailAddress","reserved":false,"verification":null,"linked_to":[],"created_at":1732018818573,"updated_at":1732018818573},{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018817848,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1731931563814,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test2+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732018817799,"updated_at":1732018817863,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTg4NzgsImlhdCI6MTczMjAxODgxOCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE4ODA4LCJzaWQiOiJzZXNzXzJwNElGWlg3Tk9Jd25aV0htZHZ5V0lsVUN1bCIsInN1YiI6InVzZXJfMm1uS1o0ZXhpUHBIWTczMDhYeno5bWdmSldOIn0.wx96DzzUaD-hwTv4TnJWX30f7ttRDzu9PdGkEz2sHNCC_jF8N7W-fQy6soa0We7aycz1tm3TGJBxdI4qWFfV3ADERRbF1dWBU_UvgV5HT9Jt8TGR1CW1k2a6vw9eX-4a_NbnWbm_ohQv0lY-cLQzTOFsTDoKD991HpJklHC1wVDeVMo_raMMJteNZkF7yoT9ap-_OMBeFi6ZhTTcZGZJ4l8e4g30WrkvLbunpB9h4NcgGXRbhOr3cfVZ7X8T3KfOOjpo7HqbPs24Gn37WyG-Obu4efzmTuzbUj571L52LkR8yVubAJ0F12J9aPjUUMklrSD-f-h5SQEz8PGIDcwgcA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732018817312,"updated_at":1732018817860}}',
        );
        httpService.expect(
          'DELETE /v1/me/email_addresses/IDENTIFIER_ID?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"IDENTIFIER_ID","object":"email_address","deleted":true},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734610817790,"last_active_at":1732018817790,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test2","first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test2+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727706952389,"updated_at":1729075139751}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550102","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727706952398,"updated_at":1727706952398}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732018817799,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727706952371,"updated_at":1732018819153,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732018817874,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test2","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktaNGV4aVBwSFk3MzA4WHp6OW1nZkpXTiIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test2+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732018817799,"updated_at":1732018817863,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTg4NzksImlhdCI6MTczMjAxODgxOSwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE4ODA5LCJzaWQiOiJzZXNzXzJwNElGWlg3Tk9Jd25aV0htZHZ5V0lsVUN1bCIsInN1YiI6InVzZXJfMm1uS1o0ZXhpUHBIWTczMDhYeno5bWdmSldOIn0.zG_t1LLBv3k96O3boYAg3z4Mmex6dDvVy2ESX7OwMGGqvwPLvANJTlGlK93EU8dBplJrIjmF7db8Ls_1GiDoRUO5AguNB8fa3q3skndC5Vj2VELJeZQavrJ-jUELLhG35cZypwA7s0LOX0w_JnfbtAp4doPgiN28X-PfBr35SfSbAAWhW1UrMdM97MQnIqLPnVy_bngDv22_cx7EH8eu9wDC0pLtPvLHfSrE1YNyyqdxHTJrRR9IbF1h0Oun9fcDUryOGlWwXYzaF-sNVOM_jsFzIpAR9RydKDpqXiuX61R4IRCTeg1Bdm9_9eUZSuo2Ip-m7Fjs_Zk-L8533gB3PA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732018817312,"updated_at":1732018817860}}',
        );

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        expect(user is User, true);

        response = await api.addIdentifyingDataToCurrentUser(
            emailAddress, IdentifierType.emailAddress);
        expect(response.isOkay, true);

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        final email = user?.emailAddresses
            ?.where((e) => e.emailAddress == emailAddress)
            .first;
        expect(email is Email, true);

        response = await api.deleteIdentifyingData(email!);
        expect(response.isOkay, true);
      });
    });

    test('with additional phone number', () async {
      await runWithLogging(() async {
        await signIn(3);

        late ApiResponse response;
        late User? user;

        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019134202,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611134142,"last_active_at":1732019134142,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019134202,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test3+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019134152,"updated_at":1732019134220,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTkxOTQsImlhdCI6MTczMjAxOTEzNCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5MTI0LCJzaWQiOiJzZXNzXzJwNEl0UGl5Uno0RWt0M1hnREtWOVNSUUIxZiIsInN1YiI6InVzZXJfMm1uS2p3OUZXUzlUdnE4bjFBamUxbHFkZWVzIn0.WiFuA-8LMCnvxTp7eod5m7k7yLhJlz1LCU-mN0ziJRwn-R_fM6lZere7z-5TM-p5zoHzZoEPowDXKgf94U_VuS2Xp--vFCueVat3-upXWMvoSmn5dwR4PTjfJl-ZYW0zupebbmE9goooICa73F52YD0qGueYI_rcyFCU_NmEAhaPyy7jIW5RU6a9Frin3SLg0P1UcRIs2PeLGNFyeooyMGVgFeKdST8PmHbd0X0gRASFGaSu7LDSWy5kC1PCdM0pINrYnTCr0TUsw6TubgBz7GUmrhMYFkFQ-x4HKasYZuHAU-SR-Fl6K69YsaFkAH57qO8sJLABRph78EsWFokbJg"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019133645,"updated_at":1732019134214}}',
        );
        httpService.expect(
          'POST /v1/me/phone_numbers?_clerk_session_id=SESSION_ID phone_number=+447700777777',
          200,
          '{"response":{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+447700777777","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":null,"linked_to":[],"backup_codes":null,"created_at":1732019134824,"updated_at":1732019134824},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611134142,"last_active_at":1732019134142,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+447700777777","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":null,"linked_to":[],"backup_codes":null,"created_at":1732019134824,"updated_at":1732019134824},{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019134202,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test3+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019134152,"updated_at":1732019134220,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTkxOTQsImlhdCI6MTczMjAxOTEzNCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5MTI0LCJzaWQiOiJzZXNzXzJwNEl0UGl5Uno0RWt0M1hnREtWOVNSUUIxZiIsInN1YiI6InVzZXJfMm1uS2p3OUZXUzlUdnE4bjFBamUxbHFkZWVzIn0.WiFuA-8LMCnvxTp7eod5m7k7yLhJlz1LCU-mN0ziJRwn-R_fM6lZere7z-5TM-p5zoHzZoEPowDXKgf94U_VuS2Xp--vFCueVat3-upXWMvoSmn5dwR4PTjfJl-ZYW0zupebbmE9goooICa73F52YD0qGueYI_rcyFCU_NmEAhaPyy7jIW5RU6a9Frin3SLg0P1UcRIs2PeLGNFyeooyMGVgFeKdST8PmHbd0X0gRASFGaSu7LDSWy5kC1PCdM0pINrYnTCr0TUsw6TubgBz7GUmrhMYFkFQ-x4HKasYZuHAU-SR-Fl6K69YsaFkAH57qO8sJLABRph78EsWFokbJg"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019133645,"updated_at":1732019134214}}',
        );
        httpService.expect(
          'GET /v1/me?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+447700777777","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":null,"linked_to":[],"backup_codes":null,"created_at":1732019134824,"updated_at":1732019134824},{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019134202,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611134142,"last_active_at":1732019134142,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+447700777777","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":null,"linked_to":[],"backup_codes":null,"created_at":1732019134824,"updated_at":1732019134824},{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019134202,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test3+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019134152,"updated_at":1732019134220,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTkxOTUsImlhdCI6MTczMjAxOTEzNSwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5MTI1LCJzaWQiOiJzZXNzXzJwNEl0UGl5Uno0RWt0M1hnREtWOVNSUUIxZiIsInN1YiI6InVzZXJfMm1uS2p3OUZXUzlUdnE4bjFBamUxbHFkZWVzIn0.V8Y9L9LDVWEt1oZILVU8PhJ32dmJom-y4Bjm94SiffdO4m3ujp88ThYOO8sLdjcucAQqujG82kZhxSU7zezt445AlyAKGqxheM0VAp1uEVg2TYie71B0XDgieBYG0pTLyS3CoYrWRvOlU4w8aiNnkfMWW0FjLKwWk63p6UsNqaAuYI0BVpG1i-qaE26qMXvLRjmYoESawSQpzhOu67Hj2jsZOEQYuswC_OFYEPKJ45ERDMaPKGyrzoMUypD0zLFgYXtgrtsYmTHU6CrKOG9ZgZ47wI91V-KZyQDKNlf5FPhVVew6bawmH7ancmdjD1N3WZmb_8L1uyPdxZK4uBsqiA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019133645,"updated_at":1732019134214}}',
        );
        httpService.expect(
          'DELETE /v1/me/phone_numbers/IDENTIFIER_ID?_clerk_session_id=SESSION_ID',
          200,
          '{"response":{"id":"IDENTIFIER_ID","object":"phone_number","deleted":true},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611134142,"last_active_at":1732019134142,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test3","first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test3+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707038579,"updated_at":1729075139862}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550103","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707038594,"updated_at":1727707038594}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019134152,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707038528,"updated_at":1732019135407,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732019134226,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test3","last_name":"Tester","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktqdzlGV1M5VHZxOG4xQWplMWxxZGVlcyIsImluaXRpYWxzIjoiVFQifQ","has_image":false,"identifier":"test3+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019134152,"updated_at":1732019134220,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTkxOTUsImlhdCI6MTczMjAxOTEzNSwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5MTI1LCJzaWQiOiJzZXNzXzJwNEl0UGl5Uno0RWt0M1hnREtWOVNSUUIxZiIsInN1YiI6InVzZXJfMm1uS2p3OUZXUzlUdnE4bjFBamUxbHFkZWVzIn0.V8Y9L9LDVWEt1oZILVU8PhJ32dmJom-y4Bjm94SiffdO4m3ujp88ThYOO8sLdjcucAQqujG82kZhxSU7zezt445AlyAKGqxheM0VAp1uEVg2TYie71B0XDgieBYG0pTLyS3CoYrWRvOlU4w8aiNnkfMWW0FjLKwWk63p6UsNqaAuYI0BVpG1i-qaE26qMXvLRjmYoESawSQpzhOu67Hj2jsZOEQYuswC_OFYEPKJ45ERDMaPKGyrzoMUypD0zLFgYXtgrtsYmTHU6CrKOG9ZgZ47wI91V-KZyQDKNlf5FPhVVew6bawmH7ancmdjD1N3WZmb_8L1uyPdxZK4uBsqiA"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019133645,"updated_at":1732019134214}}',
        );

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        expect(user is User, true);

        const phoneNumber = '+447700777777';

        response = await api.addIdentifyingDataToCurrentUser(
          phoneNumber,
          IdentifierType.phoneNumber,
        );
        expect(response.isOkay, true);

        response = await api.getUser();
        user = response.client?.activeSession?.user;
        final number = user?.phoneNumbers
            ?.where((p) => p.phoneNumber == phoneNumber)
            .first;
        expect(number is PhoneNumber, true);

        response = await api.deleteIdentifyingData(number!);
        expect(response.isOkay, true);
      });
    });
  });
}
