import 'package:clerk_auth/src/clerk_auth/auth.dart';
import 'package:clerk_auth/src/models/client/strategy.dart';
import 'package:clerk_auth/src/models/client/user.dart';
import 'package:clerk_auth/src/models/enums.dart';
import 'package:clerk_auth/src/utils/logging.dart';
import 'package:logging/logging.dart';
import 'package:test/test.dart';

import '../../test_helpers.dart';

void main() {
  late final Auth auth;
  late final TestEnv env;
  final httpService = TestHttpService();
  final expireAt = DateTime.timestamp() //
      .add(const Duration(minutes: 5))
      .millisecondsSinceEpoch;

  setUpAll(() async {
    env = TestEnv('.env.test');
    auth = Auth(
      publishableKey: env.publishableKey,
      persistor: Persistor.none,
      httpService: httpService,
    );

    httpService.expect(
      'POST /v1/client',
      200,
      '{"response":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":null,"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732019672385,"updated_at":1732019672391},"client":null}',
    );
    httpService.expect(
      'GET /v1/environment',
      200,
      '{"auth_config":{"object":"auth_config","id":"AUTH_CONFIG_ID","first_name":"on","last_name":"on","email_address":"on","phone_number":"on","username":"on","password":"required","identification_requirements":[["email_address","oauth_apple","oauth_github","oauth_google","oauth_token_apple","phone_number"],["username"]],"identification_strategies":["email_address","oauth_apple","oauth_github","oauth_google","phone_number","username"],"first_factors":["email_code","email_link","google_one_tap","oauth_apple","oauth_github","oauth_google","oauth_token_apple","password","phone_code","reset_password_email_code","reset_password_phone_code","ticket"],"second_factors":["phone_code"],"email_address_verification_strategies":["email_code"],"single_session_mode":false,"enhanced_email_deliverability":false,"test_mode":true,"cookieless_dev":true,"url_based_session_syncing":true,"demo":false},"display_config":{"object":"display_config","id":"DISPLAY_CONFIG_ID","instance_environment_type":"development","application_name":"Flutter SDK Test","theme":{"buttons":{"font_color":"#ffffff","font_family":"\\"Source Sans Pro\\", sans-serif","font_weight":"600"},"general":{"color":"#6c47ff","padding":"1em","box_shadow":"0 2px 8px rgba(0, 0, 0, 0.2)","font_color":"#151515","font_family":"\\"Source Sans Pro\\", sans-serif","border_radius":"0.5em","background_color":"#ffffff","label_font_weight":"600"},"accounts":{"background_color":"#ffffff"}},"preferred_sign_in_strategy":"password","logo_image_url":"https://img.clerk.com/eyJ0eXBlIjoicHJveHkiLCJzcmMiOiJodHRwczovL2ltYWdlcy5jbGVyay5kZXYvdXBsb2FkZWQvaW1nXzJuYzhPMll4aHg1UXdIYU9NTjBrQUhSUmIyTiJ9","favicon_image_url":"","home_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","sign_in_url":"https://CLERK-ACCOUNT.accounts.dev/sign-in","sign_up_url":"https://CLERK-ACCOUNT.accounts.dev/sign-up","USER_ID":"https://CLERK-ACCOUNT.accounts.dev/user","waitlist_url":"https://CLERK-ACCOUNT.accounts.dev/waitlist","after_sign_in_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","after_sign_up_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","after_sign_out_one_url":"https://CLERK-ACCOUNT.accounts.dev/sign-in/choose","after_sign_out_all_url":"https://CLERK-ACCOUNT.accounts.dev/sign-in","after_switch_session_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","after_join_waitlist_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","organization_profile_url":"https://CLERK-ACCOUNT.accounts.dev/organization","create_organization_url":"https://CLERK-ACCOUNT.accounts.dev/create-organization","after_leave_organization_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","after_create_organization_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","logo_link_url":"https://CLERK-ACCOUNT.accounts.dev/default-redirect","support_email":null,"branded":true,"experimental_force_oauth_first":false,"clerk_js_version":"5","show_devmode_warning":true,"google_one_tap_client_id":"fake.com","help_url":null,"privacy_policy_url":null,"terms_url":null,"logo_url":"https://images.clerk.dev/uploaded/IMAGE_ID","favicon_url":null,"logo_image":{"object":"image","id":"IMAGE_ID","public_url":"https://images.clerk.dev/uploaded/IMAGE_ID"},"favicon_image":null,"captcha_public_key":null,"captcha_widget_type":null,"captcha_public_key_invisible":null,"captcha_provider":null,"captcha_oauth_bypass":[]},"USER_ID":{"attributes":{"email_address":{"enabled":true,"required":false,"used_for_first_factor":true,"first_factors":["email_code","email_link"],"used_for_second_factor":false,"second_factors":[],"verifications":["email_code"],"verify_at_sign_up":true},"phone_number":{"enabled":true,"required":false,"used_for_first_factor":true,"first_factors":["phone_code"],"used_for_second_factor":true,"second_factors":["phone_code"],"verifications":["phone_code"],"verify_at_sign_up":true},"username":{"enabled":true,"required":false,"used_for_first_factor":true,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"web3_wallet":{"enabled":false,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"first_name":{"enabled":true,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"last_name":{"enabled":true,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"password":{"enabled":true,"required":true,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"authenticator_app":{"enabled":false,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"ticket":{"enabled":true,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"backup_code":{"enabled":false,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false},"passkey":{"enabled":false,"required":false,"used_for_first_factor":false,"first_factors":[],"used_for_second_factor":false,"second_factors":[],"verifications":[],"verify_at_sign_up":false}},"sign_in":{"second_factor":{"required":false}},"sign_up":{"captcha_enabled":false,"captcha_widget_type":"smart","custom_action_required":false,"progressive":true,"mode":"public","legal_consent_enabled":false},"restrictions":{"allowlist":{"enabled":false},"blocklist":{"enabled":false},"block_email_subaddresses":{"enabled":false},"block_disposable_email_domains":{"enabled":false},"ignore_dots_for_gmail_addresses":{"enabled":false}},"username_settings":{"min_length":4,"max_length":64},"actions":{"delete_self":true,"create_organization":true,"create_organizations_limit":null},"attack_protection":{"USER_ID":{"enabled":true,"max_attempts":100,"duration_in_minutes":60},"pii":{"enabled":true},"email_link":{"require_same_client":false}},"passkey_settings":{"allow_autofill":true,"show_sign_in_button":true},"social":{"oauth_apple":{"enabled":true,"required":false,"authenticatable":true,"block_email_subaddresses":false,"strategy":"oauth_apple","not_selectable":false,"deprecated":false,"name":"Apple","logo_url":"https://img.clerk.com/static/apple.png"},"oauth_custom_spung":{"enabled":false,"required":false,"authenticatable":true,"block_email_subaddresses":false,"strategy":"oauth_custom_spung","not_selectable":false,"deprecated":false,"name":"spung"},"oauth_github":{"enabled":true,"required":false,"authenticatable":true,"block_email_subaddresses":false,"strategy":"oauth_github","not_selectable":false,"deprecated":false,"name":"GitHub","logo_url":"https://img.clerk.com/static/github.png"},"oauth_google":{"enabled":true,"required":false,"authenticatable":true,"block_email_subaddresses":true,"strategy":"oauth_google","not_selectable":false,"deprecated":false,"name":"Google","logo_url":"https://img.clerk.com/static/google.png"}},"password_settings":{"disable_hibp":false,"min_length":8,"max_length":0,"require_special_char":true,"require_numbers":true,"require_uppercase":true,"require_lowercase":true,"show_zxcvbn":false,"min_zxcvbn_strength":0,"enforce_hibp_on_sign_in":false,"allowed_special_characters":"!\\"#\$%\u0026\'()*+,-./:;\u003c=\u003e?@[]^_`{|}~"},"saml":{"enabled":false},"enterprise_sso":{"enabled":false}},"organization_settings":{"enabled":false,"max_allowed_memberships":5,"actions":{"admin_delete":true},"domains":{"enabled":false,"enrollment_modes":[],"default_role":""},"creator_role":"org:admin"},"maintenance_mode":false}',
    );

    await auth.initialize();

    await setUpLogging(printer: TestLogPrinter(), level: Level.SEVERE);
  });

  tearDown(() async {
    httpService.expect('DELETE /v1/client', 200, '');
    await auth.signOut();
  });

  group('SignIn', () {
    test('can sign in with password in one step', () async {
      await runWithLogging(() async {
        httpService.expect(
          'POST /v1/client/sign_ins identifier=test1+clerk_test@some.domain&password=password',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"complete","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":null,"supported_second_factors":null,"first_factor_verification":{"status":"verified","strategy":"password","attempts":1,"expire_at":null},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":"SESSION_ID","abandon_at":1732106314053},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611914215,"last_active_at":1732019914215,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019914225,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732019914283,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732016622191,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019914225,"updated_at":1732019914327,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMTk5NzQsImlhdCI6MTczMjAxOTkxNCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5OTA0LCJzaWQiOiJzZXNzXzJwNEtUUXY5clQxd3FrUVpFMEgwNXZscldVRCIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.XDBf5movGyGyo7PYaj-QxMiv-M9E86S0RBy0KCNm6W8RGN5kruRXhDayZ0g407N3jw4gqKaepi01JAKCtX6n_yRaKoK5t-k21G4YrgMJKxTT4nyIb-dYkdjAva9VyyQIG9VifuuIRP--5DI4e17h--ClU3PMTiEKAOTiDIEg5ct9fn2-e6e0BzyNk8SDD8M21E63VVkt6F5V593iYjf1qRsttsbgGU93iv_Qc_hIVv9e6_hcqnMpzfFFWg1OmPMwgQA7l6olkDMWFefwcO4enA6FCDV1CoY9OBTNKD1mYnNjVA4RLjx278-2EqOrFpgTMoGSieMEZYWW3cW8BF9iVg"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019914028,"updated_at":1732019914320}}',
        );

        expect(auth.user, null);
        final client = await auth.attemptSignIn(
          identifier: 'test1+clerk_test@some.domain',
          strategy: Strategy.password,
          password: env.password,
        );
        expect(client.signIn, null);
        expect(client.user is User, true);
      });
    });

    test('can sign in with email code', () async {
      await runWithLogging(() async {
        expect(auth.user, null);

        httpService.expect(
          'POST /v1/client/sign_ins identifier=test1+clerk_test@some.domain',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106348550},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106348550},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732019948538,"updated_at":1732019948562}}',
        );
        httpService.expect(
          'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/prepare_first_factor strategy=email_code&email_address_id=IDENTIFIER_ID',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_code","attempts":0,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106348550},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_code","attempts":0,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106348550},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732019948538,"updated_at":1732019948989}}',
        );
        httpService.expect(
          'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/attempt_first_factor strategy=email_code&code=424242',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"complete","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":null,"supported_second_factors":null,"first_factor_verification":{"status":"verified","strategy":"email_code","attempts":1,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":"SESSION_ID","abandon_at":1732106348550},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734611949659,"last_active_at":1732019949659,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732019949663,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732019949686,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732016622191,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732019949663,"updated_at":1732019949701,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMjAwMDksImlhdCI6MTczMjAxOTk0OSwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDE5OTM5LCJzaWQiOiJzZXNzXzJwNEtYbzVobzBNNEhSdllZOEtFeUpoZnFqRSIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.o8NkLdSyMF_Q604xee1YIIFBTW89Gjwv6OPEDcNjALqFBzzYWxTo8dzYCcij_49g6GsiuvEUPefC7Mk6JmSwNDsa3pisCrAQZajWc-sfd42zczTVTH7duMD4Yn9QCc6c6LHTZU0yCPF2GY-oevBQhVE6NjnYVFjUYjMohLAK8NBGKXn5eAtQwMGL39slxIZVuuIyTx3j1FKo65Ndc5ezpQucmkD9K9YjxsakFKeT5h71ElKK0JI8PwN-tQbiJrSpp8OtGaR-AHRPLn9p5wynrPfq5KHIKZUL6Qr66c_QuGOLKSDO5eB0-b0Y22Sd2orpxsOxJ-Z0K4xeW9VL0QIJ7w"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732019948538,"updated_at":1732019949697}}',
        );

        final client = await auth.attemptSignIn(
          identifier: 'test1+clerk_test@some.domain',
          strategy: Strategy.emailCode,
          code: env.code,
        );
        expect(client.signIn, null);
        expect(client.user is User, true);
      });
    });

    test('can sign in with phone code', () async {
      await runWithLogging(() async {
        expect(auth.user, null);

        httpService.expect(
          'POST /v1/client/sign_ins identifier=test1+clerk_test@some.domain',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106416802},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106416802},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020016788,"updated_at":1732020016811}}',
        );
        httpService.expect(
          'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/prepare_first_factor strategy=phone_code&phone_number_id=IDENTIFIER_ID',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"phone_code","attempts":0,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106416802},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+*********01","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test1+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"phone_code","attempts":0,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106416802},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020016788,"updated_at":1732020017524}}',
        );
        httpService.expect(
          'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/attempt_first_factor strategy=phone_code&code=424242',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"complete","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":null,"supported_second_factors":null,"first_factor_verification":{"status":"verified","strategy":"phone_code","attempts":1,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test1+clerk_test@some.domain","USER_ID":null,"created_session_id":"SESSION_ID","abandon_at":1732106416802},"client":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734612018086,"last_active_at":1732020018086,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"test1","first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test1+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1727707000228,"updated_at":1729075139789}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+15555550101","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1727707000277,"updated_at":1727707000277}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732020018094,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1727707000164,"updated_at":1732020018124,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":1732016622191,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Test","last_name":"User","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJtbktmQms4MlhkZ0pYUzltNlhGZlkyTGZHTiIsImluaXRpYWxzIjoiVFUifQ","has_image":false,"identifier":"test1+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732020018094,"updated_at":1732020018157,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMjAwNzgsImlhdCI6MTczMjAyMDAxOCwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDIwMDA4LCJzaWQiOiJzZXNzXzJwNEtnVkprUjdSWDBvczVBSkFqUUhJNTdVZSIsInN1YiI6InVzZXJfMm1uS2ZCazgyWGRnSlhTOW02WEZmWTJMZkdOIn0.fvNQ7MVKYonJSfQXQZnSHtcLFJRYiTXAMC0JbMlZgqX_Xo8FUspCXrMqGiWSLBzqUcltA6lwsTx6oQAQc1HfqrguWPMdmP-L036ssi8u15Q2-TFJnAtZhy_LAh4J45I3AYnGRJeMezO_cy87R3PmJMLXz7TAKqI8P86hLEHKOWbSOIJTpIzsOS8LqEjB8r7VWuZjFR9OEf4Vu4oWZ69UPVYv_wm76wYbDOi79ECc7O3H86Ap1HNRnmykGR0szpz9tFQE4mJJoMUMvDpZMaInf5OusrjqTNCJhM6cmKiglhR5BLg0oCODi-SMvfXSDRqyNsUyqVgvkbcLuUnL2jT8vQ"}}],"sign_in":null,"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732020016788,"updated_at":1732020018140}}',
        );

        final client = await auth.attemptSignIn(
          identifier: 'test1+clerk_test@some.domain',
          strategy: Strategy.phoneCode,
          code: env.code,
        );
        expect(client.signIn, null);
        expect(client.user is User, true);
      });
    });

    test('can sign in with email link', () async {
      await runWithLogging(() async {
        expect(auth.user, null);

        httpService.expect(
          'POST /v1/client/sign_ins identifier=test9+clerk_test@some.domain',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":null,"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020334301,"updated_at":1732020334324}}',
        );
        httpService.expect(
          'POST /v1/client/sign_ins/SIGN_IN_ATTEMPT_ID/prepare_first_factor strategy=email_link&email_address_id=IDENTIFIER_ID&redirect_url=https://www.clerk.com',
          200,
          '{"response":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_link","attempts":null,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"client":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_link","attempts":null,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020334301,"updated_at":1732020334683}}',
        );
        httpService.expect(
          'GET /v1/client',
          200,
          '{"response":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_link","attempts":null,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020334301,"updated_at":1732020334683},"client":null}',
        );
        httpService.expect(
          'GET /v1/client',
          200,
          '{"response":{"object":"client","id":"CLIENT_ID","sessions":[],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"needs_first_factor","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":[{"strategy":"password"},{"strategy":"phone_code","safe_identifier":"+**********11","phone_number_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"email_link","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true},{"strategy":"reset_password_email_code","safe_identifier":"test9+clerk_test@some.domain","email_address_id":"IDENTIFIER_ID","primary":true}],"supported_second_factors":null,"first_factor_verification":{"status":"unverified","strategy":"email_link","attempts":null,"expire_at":$expireAt},"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":null,"abandon_at":1732106734314},"sign_up":null,"last_active_session_id":null,"cookie_expires_at":null,"created_at":1732020334301,"updated_at":1732020334683},"client":null}',
        );
        httpService.expect(
          'GET /v1/client',
          200,
          '{"response":{"object":"client","id":"CLIENT_ID","sessions":[{"object":"session","id":"SESSION_ID","status":"active","expire_at":$expireAt,"abandon_at":1734612361785,"last_active_at":1732020361785,"last_active_organization_id":null,"actor":null,"user":{"id":"USER_ID","object":"user","username":"shinyford","first_name":"Nic","last_name":"Ford","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJwNExGeFRTUUlJMUhNUkFyNFVMMlhKZmxCWSIsImluaXRpYWxzIjoiTkYifQ","has_image":false,"primary_email_address_id":"IDENTIFIER_ID","primary_phone_number_id":"IDENTIFIER_ID","primary_web3_wallet_id":null,"password_enabled":true,"two_factor_enabled":false,"totp_enabled":false,"backup_code_enabled":false,"email_addresses":[{"id":"IDENTIFIER_ID","object":"email_address","email_address":"test9+clerk_test@some.domain","reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"created_at":1732020300926,"updated_at":1732020300926}],"phone_numbers":[{"id":"IDENTIFIER_ID","object":"phone_number","phone_number":"+447957666211","reserved_for_second_factor":false,"default_second_factor":false,"reserved":false,"verification":{"status":"verified","strategy":"admin","attempts":null,"expire_at":null},"linked_to":[],"backup_codes":null,"created_at":1732020300934,"updated_at":1732020300934}],"web3_wallets":[],"passkeys":[],"external_accounts":[],"saml_accounts":[],"enterprise_accounts":[],"public_metadata":{},"unsafe_metadata":{},"external_id":null,"last_sign_in_at":1732020361787,"banned":false,"locked":false,"lockout_expires_in_seconds":null,"verification_attempts_remaining":100,"created_at":1732020300910,"updated_at":1732020361803,"delete_self_enabled":true,"create_organization_enabled":true,"last_active_at":null,"mfa_enabled_at":null,"mfa_disabled_at":null,"legal_accepted_at":null,"profile_image_url":"https://www.gravatar.com/avatar?d=mp","organization_memberships":[]},"public_user_data":{"first_name":"Nic","last_name":"Ford","image_url":"https://img.clerk.com/eyJ0eXBlIjoiZGVmYXVsdCIsImlpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJyaWQiOiJ1c2VyXzJwNExGeFRTUUlJMUhNUkFyNFVMMlhKZmxCWSIsImluaXRpYWxzIjoiTkYifQ","has_image":false,"identifier":"test9+clerk_test@some.domain","profile_image_url":"https://www.gravatar.com/avatar?d=mp"},"created_at":1732020361787,"updated_at":1732020361818,"last_active_token":{"object":"token","jwt":"eyJhbGciOiJSUzI1NiIsImNhdCI6ImNsX0I3ZDRQRDExMUFBQSIsImtpZCI6Imluc18ya3ZZdzF0WkY4OHNvQjdtN0FYaGlEQ2llMmsiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MzIwMjA0MjIsImlhdCI6MTczMjAyMDM2MiwiaXNzIjoiaHR0cHM6Ly9tb3JlLXlldGktNTMuY2xlcmsuYWNjb3VudHMuZGV2IiwibmJmIjoxNzMyMDIwMzUyLCJzaWQiOiJzZXNzXzJwNExOYnUxNm5wTzJMSmNyOWUwaDByNG5IVCIsInN1YiI6InVzZXJfMnA0TEZ4VFNRSUkxSE1SQXI0VUwyWEpmbEJZIn0.hnF7H_r478o--fNokeerGNYX178OKlmBSBnnKOPK5YaUPfK9sp64uVVc3oENyf30LpzDgz88VIoMiRUJI5jTCfWOzxp55n9b0aAl2KQEyeBq5Zzx_w3G6Tt2NVZfiQ0M9V8YRXavaOc0NI0fpOgU-jJRq4QFsGDI_aCeEoNQ1hzGHx3lYR9Hh4D8O1GbV6TnrD-K-KKOWr1Nri-zspDAjj02kPntsjwzVfYCOBkiTR2eTW0YZoMQ7iLnNHfa5BW6QOuDMn6C9Rrm7F46JbQ51A-ZAiB8Hyn9Hr5Y4-JiPzbVpS0AzWNqF1Dw0kCFvFC_CsoNXTdyFit7lf9iK5NneQ"}}],"sign_in":{"object":"sign_in_attempt","id":"SIGN_IN_ATTEMPT_ID","status":"complete","supported_identifiers":["email_address","phone_number","username"],"supported_first_factors":null,"supported_second_factors":null,"first_factor_verification":{"status":"verified","strategy":"email_link","attempts":null,"expire_at":$expireAt,"verified_at_client":"CLIENT_ID"},"second_factor_verification":null,"identifier":"test9+clerk_test@some.domain","USER_ID":null,"created_session_id":"SESSION_ID","abandon_at":1732106734314},"sign_up":null,"last_active_session_id":"SESSION_ID","cookie_expires_at":null,"created_at":1732020334301,"updated_at":1732020361814},"client":null}',
        );

        final client = await auth.attemptSignIn(
          identifier: 'test9+clerk_test@some.domain',
          strategy: Strategy.emailLink,
          redirectUrl: 'https://www.clerk.com',
        );
        expect(client.signIn?.status, Status.complete);
        expect(client.user is User, true);
      });
    });
  });
}
